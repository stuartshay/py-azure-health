name: Infrastructure What-If

on:
  pull_request:
    paths:
      - 'infrastructure/bicep/**'
      - '.github/workflows/infrastructure-*.yml'
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to preview'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}

jobs:
  what-if:
    name: Preview Infrastructure Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          fi

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run What-If analysis
        id: whatif
        run: |
          echo "üîç Running What-If analysis for ${{ steps.env.outputs.environment }} environment..."

          # Run what-if and capture output
          WHATIF_OUTPUT=$(az deployment group what-if \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infrastructure/bicep/main.bicep \
            --parameters environment=${{ steps.env.outputs.environment }} \
            --result-format FullResourcePayloads \
            2>&1 || true)

          echo "$WHATIF_OUTPUT"

          # Save output to file for PR comment
          echo "$WHATIF_OUTPUT" > whatif-output.txt

          # Check for errors
          if echo "$WHATIF_OUTPUT" | grep -qi "error"; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Azure Policy Compliance
        id: policy
        if: success() || failure()
        continue-on-error: true
        run: |
          echo "üîí Checking Azure Policy compliance for resource group..."

          # Get policy compliance state
          POLICY_OUTPUT=$(az policy state list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[].{resourceId:resourceId, policyDefinition:policyDefinitionName, complianceState:complianceState, policyAssignment:policyAssignmentName}" \
            --output json 2>&1 || echo "[]")

          echo "$POLICY_OUTPUT" > policy-compliance.json

          # Count compliance states
          NON_COMPLIANT=$(echo "$POLICY_OUTPUT" | jq '[.[] | select(.complianceState=="NonCompliant")] | length' 2>/dev/null || echo "0")
          COMPLIANT=$(echo "$POLICY_OUTPUT" | jq '[.[] | select(.complianceState=="Compliant")] | length' 2>/dev/null || echo "0")

          # Strip whitespace
          NON_COMPLIANT=$(echo "${NON_COMPLIANT}" | tr -d '[:space:]')
          COMPLIANT=$(echo "${COMPLIANT}" | tr -d '[:space:]')

          # Default to 0 if empty
          NON_COMPLIANT=${NON_COMPLIANT:-0}
          COMPLIANT=${COMPLIANT:-0}

          echo "non_compliant=${NON_COMPLIANT}" >> "$GITHUB_OUTPUT"
          echo "compliant=${COMPLIANT}" >> "$GITHUB_OUTPUT"

          if [ "$NON_COMPLIANT" -gt "0" ]; then
            echo "policy_issues=true" >> "$GITHUB_OUTPUT"
            echo "‚ö†Ô∏è Found ${NON_COMPLIANT} non-compliant resources"
          else
            echo "policy_issues=false" >> "$GITHUB_OUTPUT"
            echo "‚úÖ All resources are policy compliant"
          fi

          # Generate detailed policy report
          echo "## Policy Compliance Details" > policy-report.md
          echo "" >> policy-report.md
          if [ "$NON_COMPLIANT" -gt "0" ]; then
            echo "### ‚ùå Non-Compliant Resources" >> policy-report.md
            echo "\`\`\`json" >> policy-report.md
            echo "$POLICY_OUTPUT" | jq '[.[] | select(.complianceState=="NonCompliant")]' >> policy-report.md
            echo "\`\`\`" >> policy-report.md
          fi

      - name: Parse What-If results
        id: parse
        if: success() || failure()
        run: |
          if [ -f whatif-output.txt ]; then
            # Count changes - ensure we get numeric values and strip whitespace
            CREATE_COUNT=$(grep -c "Create" whatif-output.txt 2>/dev/null || echo "0")
            MODIFY_COUNT=$(grep -c "Modify" whatif-output.txt 2>/dev/null || echo "0")
            DELETE_COUNT=$(grep -c "Delete" whatif-output.txt 2>/dev/null || echo "0")
            IGNORE_COUNT=$(grep -c "Ignore" whatif-output.txt 2>/dev/null || echo "0")

            # Strip whitespace and ensure we have clean integers
            CREATE_COUNT=$(echo "${CREATE_COUNT}" | tr -d '[:space:]')
            MODIFY_COUNT=$(echo "${MODIFY_COUNT}" | tr -d '[:space:]')
            DELETE_COUNT=$(echo "${DELETE_COUNT}" | tr -d '[:space:]')
            IGNORE_COUNT=$(echo "${IGNORE_COUNT}" | tr -d '[:space:]')

            # Default to 0 if empty
            CREATE_COUNT=${CREATE_COUNT:-0}
            MODIFY_COUNT=${MODIFY_COUNT:-0}
            DELETE_COUNT=${DELETE_COUNT:-0}
            IGNORE_COUNT=${IGNORE_COUNT:-0}

            echo "create_count=${CREATE_COUNT}" >> "$GITHUB_OUTPUT"
            echo "modify_count=${MODIFY_COUNT}" >> "$GITHUB_OUTPUT"
            echo "delete_count=${DELETE_COUNT}" >> "$GITHUB_OUTPUT"
            echo "ignore_count=${IGNORE_COUNT}" >> "$GITHUB_OUTPUT"

            TOTAL_CHANGES=$((CREATE_COUNT + MODIFY_COUNT + DELETE_COUNT))
            echo "total_changes=${TOTAL_CHANGES}" >> "$GITHUB_OUTPUT"

            echo "üìä Changes detected: ${CREATE_COUNT} create, ${MODIFY_COUNT} modify, ${DELETE_COUNT} delete"
          else
            # File doesn't exist, set defaults
            echo "create_count=0" >> "$GITHUB_OUTPUT"
            echo "modify_count=0" >> "$GITHUB_OUTPUT"
            echo "delete_count=0" >> "$GITHUB_OUTPUT"
            echo "ignore_count=0" >> "$GITHUB_OUTPUT"
            echo "total_changes=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const whatifOutput = fs.readFileSync('whatif-output.txt', 'utf8');

            const createCount = '${{ steps.parse.outputs.create_count }}';
            const modifyCount = '${{ steps.parse.outputs.modify_count }}';
            const deleteCount = '${{ steps.parse.outputs.delete_count }}';
            const totalChanges = '${{ steps.parse.outputs.total_changes }}';
            const hasErrors = '${{ steps.whatif.outputs.has_errors }}';
            const nonCompliant = '${{ steps.policy.outputs.non_compliant }}';
            const compliant = '${{ steps.policy.outputs.compliant }}';
            const policyIssues = '${{ steps.policy.outputs.policy_issues }}';

            let icon = '‚úÖ';
            let status = 'No infrastructure changes detected';

            if (hasErrors === 'true') {
              icon = '‚ùå';
              status = 'What-If analysis failed with errors';
            } else if (totalChanges > 0) {
              icon = '‚ö†Ô∏è';
              status = `${totalChanges} infrastructure change(s) detected`;
            }

            // Read policy report if it exists
            let policySection = '';
            if (fs.existsSync('policy-report.md')) {
              const policyReport = fs.readFileSync('policy-report.md', 'utf8');
              policySection = `
            ### üîí Policy Compliance
            | Status | Count |
            | --- | --- |
            | ‚úÖ Compliant | ${compliant} |
            | ‚ùå Non-Compliant | ${nonCompliant} |

            ${policyIssues === 'true' ? policyReport : '‚úÖ All resources are policy compliant'}
            `;
            }

            const comment = `## ${icon} Infrastructure What-If Analysis

            **Environment:** dev
            **Status:** ${status}

            ### Summary
            | Action | Count |
            | --- | --- |
            | ‚ûï Create | ${createCount} |
            | üîÑ Modify | ${modifyCount} |
            | ‚ùå Delete | ${deleteCount} |
            | ‚è≠Ô∏è Ignore | ${{ steps.parse.outputs.ignore_count }} |

            ${policySection}

            <details>
            <summary>View detailed changes</summary>

            \`\`\`
            ${whatifOutput.substring(0, 60000)}
            \`\`\`

            </details>

            ${hasErrors === 'true' ? '‚ö†Ô∏è **Please review the errors above before merging.**' : ''}
            ${totalChanges > 0 ? '‚ö†Ô∏è **Review changes carefully before deploying to production.**' : ''}
            ${policyIssues === 'true' ? '‚ö†Ô∏è **Policy compliance issues detected. Please remediate before deployment.**' : ''}

            ---
            *Workflow run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Infrastructure What-If Analysis')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Display summary
        if: success() || failure()
        run: |
          echo "## üîç What-If Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to Create | ${{ steps.parse.outputs.create_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to Modify | ${{ steps.parse.outputs.modify_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to Delete | ${{ steps.parse.outputs.delete_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Changes | ${{ steps.parse.outputs.total_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üîí Policy Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Compliant Resources | ${{ steps.policy.outputs.compliant }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Non-Compliant Resources | ${{ steps.policy.outputs.non_compliant }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.whatif.outputs.has_errors }}" = "true" ]; then
            echo "‚ùå **What-If analysis completed with errors. Review the logs above.**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.parse.outputs.total_changes }}" -gt "0" ]; then
            echo "‚ö†Ô∏è **Infrastructure changes detected. Review carefully before deployment.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **No infrastructure changes detected.**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.policy.outputs.policy_issues }}" = "true" ]; then
            echo "‚ö†Ô∏è **Policy compliance issues detected. Review and remediate before deployment.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **All resources are policy compliant.**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload What-If output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: whatif-output-${{ github.run_id }}
          path: whatif-output.txt
          retention-days: 30

      - name: Upload Policy Compliance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-compliance-${{ github.run_id }}
          path: |
            policy-compliance.json
            policy-report.md
          retention-days: 30
