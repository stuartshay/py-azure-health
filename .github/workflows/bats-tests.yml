name: BATS Script Tests

on:
  pull_request:
    paths:
      - 'scripts/**/*.sh'
      - 'tests/**/*.bats'
      - '.github/workflows/bats-tests.yml'
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  test-scripts:
    name: Run BATS Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup BATS
        uses: mig4/setup-bats@v1
        with:
          bats-version: 1.11.0

      - name: Install BATS libraries
        run: |
          # Install bats-support and bats-assert for better test assertions
          git clone https://github.com/bats-core/bats-support.git /tmp/bats-support
          git clone https://github.com/bats-core/bats-assert.git /tmp/bats-assert

          # Make them available to tests
          echo "export BATS_LIB_PATH=/tmp" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          # Install jq for JSON processing in scripts
          sudo apt-get update
          sudo apt-get install -y jq shellcheck

      - name: Validate shell scripts
        run: |
          echo "ðŸ” Validating shell scripts with ShellCheck..."
          find scripts -name "*.sh" -type f -exec shellcheck -S warning {} +

      - name: Run workflow tests
        run: |
          echo "ðŸ§ª Running workflow script tests..."
          bats tests/workflows/policy-query.bats

      - name: Run script tests
        run: |
          echo "ðŸ§ª Running function app script tests..."
          bats tests/scripts/test-function-app.bats

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ§ª BATS Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Files" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Policy Query Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Function App Script Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All shell script tests passed successfully!" >> $GITHUB_STEP_SUMMARY
