name: Function Deploy

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'requirements.txt'
      - '.github/workflows/function-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: '3.11'
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  build:
    name: Build Function App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create and activate virtual environment
        run: |
          cd src
          python -m venv .venv
          source .venv/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          cd src
          python -m pip install --upgrade pip
          pip install -r ../requirements.txt

      - name: Prepare artifact
        run: |
          cd src
          # Remove virtual environment and cache
          rm -rf .venv __pycache__
          # Create deployment package
          zip -r ../function-app.zip . -x "*.pyc" -x "*/__pycache__/*" -x ".venv/*"

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: function-app
          path: function-app.zip
          retention-days: 1

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v6
        with:
          name: function-app

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Function App name
        id: get-function-app
        run: |
          # Get the latest deployment to find function app name
          FUNCTION_APP_NAME=$(az deployment group list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query '[0].properties.outputs.functionAppName.value' \
            --output tsv)

          if [ -z "$FUNCTION_APP_NAME" ]; then
            echo "âŒ No Function App found. Please deploy infrastructure first."
            exit 1
          fi

          echo "functionAppName=$FUNCTION_APP_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Found Function App: $FUNCTION_APP_NAME"

      - name: Deploy to Azure Functions
        uses: azure/functions-action@v1
        with:
          app-name: ${{ steps.get-function-app.outputs.functionAppName }}
          package: function-app.zip
          scm-do-build-during-deployment: true
          enable-oryx-build: true

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for deployment to complete..."
          sleep 30

      - name: Get Function URL
        id: get-url
        run: |
          FUNCTION_APP_NAME="${{ steps.get-function-app.outputs.functionAppName }}"

          # Get the default hostname
          HOSTNAME=$(az functionapp show \
            --name $FUNCTION_APP_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query 'defaultHostName' \
            --output tsv)

          # Get function key
          FUNCTION_KEY=$(az functionapp function keys list \
            --name $FUNCTION_APP_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --function-name hello \
            --query 'default' \
            --output tsv 2>/dev/null || echo "")

          if [ -n "$FUNCTION_KEY" ]; then
            FUNCTION_URL="https://$HOSTNAME/api/hello?code=$FUNCTION_KEY"
          else
            FUNCTION_URL="https://$HOSTNAME/api/hello"
          fi

          echo "functionUrl=$FUNCTION_URL" >> $GITHUB_OUTPUT
          echo "âœ… Function URL: $FUNCTION_URL"

      - name: Test Function
        id: test
        run: |
          FUNCTION_URL="${{ steps.get-url.outputs.functionUrl }}"

          echo "ðŸ§ª Testing function endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "$FUNCTION_URL" || echo "")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Function is responding successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Function returned status $HTTP_CODE"
            echo "status=warning" >> $GITHUB_OUTPUT
          fi

      - name: Display deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'dev' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Function App | ${{ steps.get-function-app.outputs.functionAppName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Version | ${{ env.PYTHON_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Function Endpoint" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.get-url.outputs.functionUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test.outputs.status }}" = "success" ]; then
            echo "âœ… **Function is deployed and responding successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Function deployed but may need verification.**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test the function using the URL above" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor logs in Application Insights" >> $GITHUB_STEP_SUMMARY
          echo "3. Check Azure Portal for detailed metrics" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: function-app
          failOnError: false
