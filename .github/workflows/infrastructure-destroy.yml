name: Infrastructure Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      confirm:
        description: 'Type "destroy" to confirm destruction'
        required: true
        type: string
      deleteResourceGroup:
        description: 'Delete entire resource group'
        required: true
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  confirm:
    name: Confirm Destruction
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: inputs.confirm != 'destroy'
        run: |
          echo "âŒ Destruction not confirmed. Please type 'destroy' to proceed."
          exit 1

      - name: Display warning
        run: |
          echo "## âš ï¸ WARNING: Destructive Operation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You are about to destroy infrastructure in the **${{ inputs.environment }}** environment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.deleteResourceGroup }}" = "true" ]; then
            echo "- **Delete entire resource group**: YES" >> $GITHUB_STEP_SUMMARY
            echo "- This will delete ALL resources in the resource group" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Delete entire resource group**: NO" >> $GITHUB_STEP_SUMMARY
            echo "- This will delete only resources created by Bicep deployment" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This action cannot be undone!" >> $GITHUB_STEP_SUMMARY

  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: confirm
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: List resources to be deleted
        id: list
        run: |
          echo "ðŸ“‹ Listing resources to be deleted..."
          if [ "${{ inputs.deleteResourceGroup }}" = "true" ]; then
            echo "All resources in resource group ${{ env.AZURE_RESOURCE_GROUP }} will be deleted"
            az resource list \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query '[].{Name:name, Type:type, Location:location}' \
              --output table
          else
            echo "Resources created by Bicep deployment will be deleted"
            # Get deployment history
            az deployment group list \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query '[].name' \
              --output table
          fi

      - name: Delete deployment (if not deleting resource group)
        if: inputs.deleteResourceGroup == false
        run: |
          echo "ðŸ—‘ï¸ Deleting Bicep deployment resources..."

          # Get the latest deployment name
          LATEST_DEPLOYMENT=$(az deployment group list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query '[0].name' \
            --output tsv)

          if [ -n "$LATEST_DEPLOYMENT" ]; then
            echo "Deleting deployment: $LATEST_DEPLOYMENT"

            # Delete resources created by the deployment
            # Note: Bicep doesn't support automatic deletion, so we need to delete resources manually
            # Get Function App name
            FUNCTION_APP=$(az deployment group show \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name $LATEST_DEPLOYMENT \
              --query 'properties.outputs.functionAppName.value' \
              --output tsv 2>/dev/null || echo "")

            STORAGE_ACCOUNT=$(az deployment group show \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name $LATEST_DEPLOYMENT \
              --query 'properties.outputs.storageAccountName.value' \
              --output tsv 2>/dev/null || echo "")

            APP_INSIGHTS=$(az deployment group show \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name $LATEST_DEPLOYMENT \
              --query 'properties.outputs.appInsightsName.value' \
              --output tsv 2>/dev/null || echo "")

            LOG_ANALYTICS=$(az deployment group show \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name $LATEST_DEPLOYMENT \
              --query 'properties.outputs.logAnalyticsWorkspaceName.value' \
              --output tsv 2>/dev/null || echo "")

            # Delete resources in order
            if [ -n "$FUNCTION_APP" ]; then
              echo "Deleting Function App: $FUNCTION_APP"
              az functionapp delete --name "$FUNCTION_APP" --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
            fi

            if [ -n "$STORAGE_ACCOUNT" ]; then
              echo "Deleting Storage Account: $STORAGE_ACCOUNT"
              az storage account delete --name "$STORAGE_ACCOUNT" --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --yes || true
            fi

            if [ -n "$APP_INSIGHTS" ]; then
              echo "Deleting Application Insights: $APP_INSIGHTS"
              az monitor app-insights component delete --app "$APP_INSIGHTS" --resource-group ${{ env.AZURE_RESOURCE_GROUP }} || true
            fi

            if [ -n "$LOG_ANALYTICS" ]; then
              echo "Deleting Log Analytics Workspace: $LOG_ANALYTICS"
              az monitor log-analytics workspace delete --workspace-name "$LOG_ANALYTICS" --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --yes || true
            fi

            echo "âœ… Resources deleted successfully"
          else
            echo "No deployments found to delete"
          fi

      - name: Delete resource group
        if: inputs.deleteResourceGroup == true
        run: |
          echo "ðŸ—‘ï¸ Deleting resource group ${{ env.AZURE_RESOURCE_GROUP }}..."
          az group delete \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes \
            --no-wait
          echo "âœ… Resource group deletion initiated"

      - name: Display summary
        run: |
          echo "## ðŸ—‘ï¸ Destruction Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ env.AZURE_RESOURCE_GROUP }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.deleteResourceGroup }}" = "true" ]; then
            echo "| Action | Resource group deletion initiated |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Action | Deployment resources deleted |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Resources have been destroyed as requested." >> $GITHUB_STEP_SUMMARY
